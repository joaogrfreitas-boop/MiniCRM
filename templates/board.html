{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">Board (Contatos por Estágio)</h2>
<style>.column-dropzone{min-height:40px}.column-dropzone.drag-over{outline:2px dashed #0d6efd;background:rgba(13,110,253,.05)}.kanban-item{font-size:.9rem;padding:.25rem .5rem;cursor:grab}.kanban-item .company{font-weight:600}</style>
<div class="row row-cols-1 row-cols-md-3 row-cols-xl-4 g-3" id="board">
  {% for stage in stages %}
  <div class="col"><div class="card h-100"><div class="card-header d-flex justify-content-between align-items-center"><span>{{ stage }}</span><span class="badge bg-secondary">{{ (columns[stage] or [])|length }}</span></div>
    <div class="card-body column-dropzone p-2" data-stage="{{ stage }}">
      {% for r in columns[stage] %}<div class="kanban-item border rounded mb-1" draggable="true" data-id="{{ r['id'] }}"><span class="company">{{ r['company_name'] }}</span><span class="text-muted"> — {{ r['name'] }}</span></div>{% else %}<div class="text-muted small">Sem itens.</div>{% endfor %}
    </div></div></div>
  {% endfor %}
</div>
<script>
let dragged=null; function bind(){document.querySelectorAll('[draggable="true"]').forEach(el=>{el.addEventListener('dragstart',e=>{dragged=el;e.dataTransfer.setData('text/plain',el.dataset.id);e.dataTransfer.effectAllowed='move'});el.addEventListener('dragend',()=>dragged=null)})} bind();
document.querySelectorAll('.column-dropzone').forEach(col=>{col.addEventListener('dragover',e=>{e.preventDefault();col.classList.add('drag-over')});col.addEventListener('dragleave',()=>col.classList.remove('drag-over'));col.addEventListener('drop',async e=>{e.preventDefault();col.classList.remove('drag-over');const id=e.dataTransfer.getData('text/plain')||(dragged&&dragged.dataset.id);if(!id)return;col.prepend(dragged);try{const res=await fetch(`/contact/${id}/move`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({stage:col.dataset.stage})});if(!res.ok)throw new Error(await res.text());document.querySelectorAll('#board .col').forEach(c=>{const badge=c.querySelector('.badge');const count=c.querySelectorAll('[draggable="true"]').length;if(badge)badge.innerText=count})}catch(err){alert('Falha ao mover: '+err);location.reload()}})});
</script>
{% endblock %}